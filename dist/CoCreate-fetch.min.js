!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.CoCreateFetch=t():e.CoCreateFetch=t()}(this,(function(){return function(e){var t={};function r(a){if(t[a])return t[a].exports;var n=t[a]={i:a,l:!1,exports:{}};return e[a].call(n.exports,n,n.exports,r),n.l=!0,n.exports}return r.m=e,r.c=t,r.d=function(e,t,a){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(r.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)r.d(a,n,function(t){return e[t]}.bind(null,n));return a},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=0)}([function(e,t,r){"use strict";r.r(t);const a={selector:"[data-template_id][data-fetch_collection]",items:[],init:function(){this.initElement(),this.__initSocketEvent(),this.__initEvents()},initElement:function(e){let t=e||document;const r=this;if(!t.querySelectorAll)return;let a=t.querySelectorAll(this.selector);0==a.length&&t!=document&&t.hasAttribute("data-template_id")&&t.hasAttribute("data-fetch_collection")&&(a=[t]),a.forEach(e=>{r.__initEachElement(e,!0,!0)})},refershElement:function(e){const{target:t}=e;t&&t.hasAttribute("data-fetch_collection")&&this.__initEachElement(t,!1,!1,!0)},reload:function(e){},__initSocketEvent:function(){const e=this;CoCreate.socket.listen("readDocumentList",(function(t){e.__fetchedItem(t)})),CoCreate.socket.listen("readCollectionList",(function(t){e.__fetchedItem(t)})),CoCreate.socket.listen("createDocument",(function(t){e.__createItem(t)})),CoCreate.socket.listen("deleteDocument",(function(t){e.__deleteItem(t)}))},__initEvents:function(){const e=this;window.addEventListener("dndsuccess",(function(t){const{dropedEl:r,dragedEl:a}=t.detail;let n=a.getAttribute("data-template_id"),i=document.querySelector(`[data-fetch_collection][data-template_id='${n}']`),l=e.findTemplateElByChild(r);i&&l&&(i.isSameNode(l)||(e.updateParentTemplateOfChild(l,a),e.reorderChildrenOfTemplate(i)),e.reorderChildrenOfTemplate(l))}))},__initEachElement:function(e,t,r,a){let n=e.getAttribute("data-template_id");if(!n)return;if(!e.getAttribute("data-fetch_collection"))return;if(CoCreateObserver.getInitialized(e,"fetch")&&t)return;let i=CoCreateFilter.getObjectByFilterId(this.items,n),l=null;const o=this;if(!t||!i){if(CoCreateObserver.setInitialized(e,"fetch"),i)l=i.filter,CoCreateFilter.changeCollection(l),a&&(i.filter.isRefresh=!0,o.__removeOldData(e),l.isRefresh=!0,l.startIndex=0);else{l=CoCreateFilter.setFilter(e,"data-template_id","template");let t=e.getAttribute("data-fetch_value_type")||"string";if(!l)return;"collection"===t&&(l.is_collection=!0),i={el:e,filter:l,templateId:n,fetch_type:t},this.items.push(i),e.addEventListener("changeFilterInput",(function(e){o.__removeOldData(i.el),i.filter.startIndex=0,i.filter.isRefresh=!0,CoCreateFilter.fetchData(i.filter)}))}CoCreateFilter.fetchData(l)}},__runLoadMore:function(e){if(!e)return;let t=CoCreateFilter.getObjectByFilterId(this.items,e);t&&t.filter.count>0&&CoCreateFilter.fetchData(t.filter)},__removeOldData:function(e){let t=e.getAttribute("data-template_id");e.querySelectorAll("[templateId='"+t+"']").forEach(e=>e.remove())},__cloneElement:function(e,t,r){let a=document.createElement(e.parentNode.tagName||"div"),n=e.cloneNode(!0);return n.setAttribute("templateId",t),r||(r="data"),n.getAttribute("data-render_array")||n.setAttribute("data-render_array",r),a.appendChild(n.cloneNode(!0)),a},__renderData:function(e,t,r="data"){let a=e.getAttribute("data-template_id"),n=e.querySelector(`.template[data-template_id='${a}'`);if(!n)return;let i=e.getAttribute("data-render_id"),l=e.getAttribute("data-pass_to"),o=i?{[i]:t}:t;r=r||"data",r=i?`${i}.${r}`:r;let c=this.__cloneElement(n,a,r);CoCreateRender.setValue(c.children,o,l,c);let d=c.querySelector(`.template[data-template_id="${a}"]`);if(!d)return;d.remove(),n.insertAdjacentHTML("beforebegin",c.innerHTML);var u=new CustomEvent("fetchedTemplate",{bubbles:!0});e.dispatchEvent(u);let s=e.parentNode.getElementsByTagName("form");for(let e=0;e<s.length;e++){let t=s[e],r=t.querySelector(".passValueBtn");r&&CoCreateLogic.__registerValuePassBtnEvent(t,r)}},__deleteItem:function(e){let t=e.collection,r=e.document_id;for(let e=0;e<this.items.length;e++){let i=this.items[e];if(i.filter.collection==t){var a=i.el.getAttribute("data-template_id"),n=i.el.querySelectorAll("[templateId='"+a+"'][data-document_id='"+r+"']");for(let e=0;e<n.length;e++)n[e].remove(),i.startIndex--}}},__fetchedItem:function(e){let t=e.element,r=CoCreateFilter.getObjectByFilterId(this.items,t);if(r){r.filter.startIndex+=e.data.length;let t=r.el.getAttribute("data-fetch_name");t&&(e=e.data[0]),e.metadata&&e.metadata.isRefresh&&this.__removeOldData(r.el),this.__renderData(r.el,e,t)}},__createItem:function(e){let t=e.collection;const r=this;let a=e.data,n=e;n.data=[a],this.items.forEach(e=>{const{filter:i}=e;e.fetch_ids=[],i.collection===t&&!e.el.getAttribute("data-fetch_name")&&r.__checkItemByFilters(a,i.filters)&&r.__renderData(e.el,n)})},findTemplateElByChild:function(e){return CoCreate.utils.getParentFromElement(e,null,["data-template_id","data-fetch_collection"])},updateParentTemplateOfChild:function(e,t){const r=e.getAttribute("data-filter_name"),a=e.getAttribute("data-filter_value"),n=e.getAttribute("data-filter_operator");r&&"$eq"==n&&CoCreate.crdt.replaceDataCrdt({collection:e.getAttribute("data-fetch_collection"),document_id:t.getAttribute("data-document_id"),name:r,value:a,broadcast:!1,update_crud:!0})},reorderChildrenOfTemplate:function(e){const t=e.getAttribute("data-order_by"),r=e.getAttribute("data-template_id");if(!t||!r)return;const a=e.querySelectorAll(`[data-template_id="${r}"][data-document_id]:not(.template)`),n="asc"!==e.getAttribute("data-order_type")?-1:1;a.forEach((r,a)=>{r.classList.contains("template")||CoCreate.crdt.replaceDataCrdt({collection:e.getAttribute("data-fetch_collection"),document_id:r.getAttribute("data-document_id"),name:t,value:a*n,broadcast:!1,update_crud:!0})})},__checkItemByFilters:function(e,t){let r=!0;return!(!e||!t)&&(!Array.isArray(e)&&(t.forEach(({name:t,operator:a,type:n,value:i})=>{const l=e[t];if(r)switch(a){case"$contain":Array.isArray(l)&&l.some(e=>i.includes(e))||(r=!1);break;case"$range":null!==i[0]&&null!==i[1]?(i[0]>l||i[1]<=l)&&(r=!1):(null==e.value[0]&&i[1]>=l||null==e.value[1]&&i[0]<=l)&&(r=!1);break;case"$eq":l!=i[0]&&(r=!1);break;case"$ne":null!=l&&l!=i[0]||(r=!1);break;case"$lt":l>=i[0]&&(r=!1);break;case"$lte":l>i[0]&&(r=!1);break;case"$gt":l<=i[0]&&(r=!1);break;case"$gte":l<i[0]&&(r=!1);break;case"$in":Array.isArray(l)&&l.some(e=>i.includes(e))||(r=!1);break;case"$nin":Array.isArray(l)&&l.some(e=>i.includes(e))&&(r=!1)}}),r))}};CoCreateObserver.add({name:"CoCreateFetchObserver",observe:["attributes"],attributes:["data-fetch_collection","data-filter_name"],task:function(e){a.refershElement(e)}}),CoCreateObserver.add({name:"CoCreateFetchInit",observe:["subtree","childList"],include:"[data-fetch_collection]",task:function(e){console.log("created element----------------"),console.log(e.target),a.initElement(e.target)}}),a.init(),t.default=a}]).default}));